<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專業版複利計算機</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .form-input {
            transition: all 0.3s ease;
        }
        .result-value {
            font-weight: 700;
            font-size: 1.75rem; /* 28px */
            line-height: 2.25rem; /* 36px */
            transition: color 0.4s ease, transform 0.4s ease;
        }
        .value-update {
            animation: pulse-light 0.7s ease-out;
        }
        @keyframes pulse-light {
            0% { color: #4f46e5; transform: scale(1); }
            50% { color: #818cf8; transform: scale(1.05); }
            100% { color: #4f46e5; transform: scale(1); }
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4f46e5;
            cursor: pointer;
            border-radius: 50%;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #4f46e5;
            cursor: pointer;
            border-radius: 50%;
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .table-container {
            max-height: 250px; /* 控制表格最大高度 */
            overflow-y: auto;
        }
        .tab-button { 
            transition: all 0.3s ease; 
            border-color: transparent;
        }
        .tab-button.active { 
            border-color: #4f46e5; 
            color: #4f46e5; 
            background-color: #eef2ff; 
        }
    </style>
</head>
<body class="bg-slate-100">

    <div class="container mx-auto p-4 max-w-7xl">
        <div class="w-full bg-white rounded-2xl shadow-lg p-6 md:p-8 grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- Input Section (Left) -->
            <div class="lg:col-span-2 flex flex-col">
                <h1 class="text-2xl md:text-3xl font-bold text-slate-800">財務規劃計算機</h1>
                <p class="mt-2 text-slate-500">從資產預測到目標規劃，全方位掌握未來。</p>

                <!-- Tabs -->
                <div class="mt-6 border-b border-gray-200">
                    <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                        <button id="tab-projection" class="tab-button active whitespace-nowrap py-3 px-2 border-b-2 font-medium text-sm">資產預測</button>
                        <button id="tab-goal" class="tab-button whitespace-nowrap py-3 px-2 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">目標規劃</button>
                    </nav>
                </div>

                <!-- Projection Mode Inputs -->
                <div id="projection-inputs">
                    <div class="mt-6 space-y-5">
                        <div>
                            <label for="initialPrincipal" class="text-sm font-medium text-slate-700">初始本金 (元)</label>
                            <div class="mt-1 relative"><span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400">$</span><input type="number" id="initialPrincipal" min="0" class="form-input w-full pl-8 pr-4 py-2 border border-slate-300 rounded-lg" value="100000"></div>
                        </div>
                        <div>
                            <label for="monthlyContribution" class="text-sm font-medium text-slate-700">每月投入 (元)</label>
                            <div class="mt-1 relative"><span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400">$</span><input type="number" id="monthlyContribution" min="0" class="form-input w-full pl-8 pr-4 py-2 border border-slate-300 rounded-lg" value="5000"></div>
                        </div>
                    </div>
                </div>

                <!-- Goal Mode Inputs -->
                <div id="goal-inputs" class="hidden">
                     <div class="mt-6 space-y-5">
                         <div>
                            <label for="financialGoal" class="text-sm font-medium text-slate-700">財務目標總額 (元)</label>
                            <div class="mt-1 relative"><span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400">$</span><input type="number" id="financialGoal" min="0" class="form-input w-full pl-8 pr-4 py-2 border border-slate-300 rounded-lg" value="20000000"></div>
                        </div>
                        <div>
                            <label for="initialPrincipalGoal" class="text-sm font-medium text-slate-700">初始本金 (元)</label>
                            <div class="mt-1 relative"><span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400">$</span><input type="number" id="initialPrincipalGoal" min="0" class="form-input w-full pl-8 pr-4 py-2 border border-slate-300 rounded-lg" value="100000"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Common Inputs -->
                <div class="mt-5 space-y-5">
                    <div>
                        <label for="annualRate" class="text-sm font-medium text-slate-700">預估年化報酬率 (%)</label>
                        <div class="mt-1 relative flex items-center"><input type="number" id="annualRate" min="0" max="50" step="0.5" class="form-input w-full pl-4 pr-8 py-2 border border-slate-300 rounded-lg" value="7"><span class="absolute right-0 pr-3 text-slate-400">%</span></div>
                        <input type="range" id="annualRateSlider" min="0" max="50" step="0.5" value="7" class="mt-2">
                    </div>
                    <div>
                        <label for="years" class="text-sm font-medium text-slate-700">投資年限 (年)</label>
                        <div class="mt-1 relative flex items-center"><input type="number" id="years" min="1" max="100" class="form-input w-full pl-4 pr-8 py-2 border border-slate-300 rounded-lg" value="20"><span class="absolute right-0 pr-3 text-slate-400">年</span></div>
                        <input type="range" id="yearsSlider" min="1" max="100" step="1" value="20" class="mt-2">
                    </div>
                    <div id="inflation-input-container">
                        <label for="inflationRate" class="text-sm font-medium text-slate-700">預估年通膨率 (%)</label>
                        <div class="mt-1 relative flex items-center"><input type="number" id="inflationRate" min="0" max="10" step="0.1" class="form-input w-full pl-4 pr-8 py-2 border border-slate-300 rounded-lg" value="2"><span class="absolute right-0 pr-3 text-slate-400">%</span></div>
                        <input type="range" id="inflationRateSlider" min="0" max="10" step="0.1" value="2" class="mt-2">
                    </div>
                </div>
            </div>

            <!-- Result and Chart Section (Right) -->
            <div class="lg:col-span-3 bg-slate-50 rounded-xl p-6 flex flex-col">
                <!-- Projection Results -->
                <div id="projection-results">
                    <h2 class="text-xl font-bold text-slate-800">資產預測結果</h2>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 bg-white rounded-lg shadow-sm">
                            <p class="text-sm text-slate-500">最終總額 (名目價值)</p>
                            <p id="futureValue" class="result-value text-indigo-600">$0</p>
                        </div>
                        <div class="p-4 bg-white rounded-lg shadow-sm">
                            <p class="text-sm text-slate-500">相當於今天的購買力</p>
                            <p id="realFutureValue" class="result-value text-teal-600">$0</p>
                        </div>
                    </div>
                    <div class="mt-4 flex-grow min-h-[250px]"><canvas id="growthChart"></canvas></div>
                    <div class="mt-6">
                        <h3 class="text-lg font-bold text-slate-800">年度明細</h3>
                        <div class="table-container mt-2 border border-slate-200 rounded-lg bg-white">
                            <table class="w-full text-sm text-left text-slate-600">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-100 sticky top-0"><tr><th scope="col" class="px-4 py-2">年度</th><th scope="col" class="px-4 py-2 text-right">投入本金</th><th scope="col" class="px-4 py-2 text-right">年度利息</th><th scope="col" class="px-4 py-2 text-right">期末總額</th></tr></thead>
                                <tbody id="detailsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- Goal Results -->
                <div id="goal-results" class="hidden">
                    <h2 class="text-xl font-bold text-slate-800">目標規劃結果</h2>
                    <div class="mt-4 p-6 bg-white rounded-lg shadow-sm text-center">
                        <p class="text-sm text-slate-500">為達成目標，您每月需投入</p>
                        <p id="requiredMonthly" class="result-value text-indigo-600">$0</p>
                        <p class="text-xs text-slate-400 mt-1">此為名目價值，未考慮通膨</p>
                    </div>
                    <div class="mt-4 text-center p-4">
                        <p id="goal-summary" class="text-slate-600"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const DOMElements = {
            tabs: { projection: document.getElementById('tab-projection'), goal: document.getElementById('tab-goal') },
            inputSections: { projection: document.getElementById('projection-inputs'), goal: document.getElementById('goal-inputs') },
            resultSections: { projection: document.getElementById('projection-results'), goal: document.getElementById('goal-results') },
            inputs: {
                initialPrincipal: document.getElementById('initialPrincipal'),
                monthlyContribution: document.getElementById('monthlyContribution'),
                financialGoal: document.getElementById('financialGoal'),
                initialPrincipalGoal: document.getElementById('initialPrincipalGoal'),
                annualRate: document.getElementById('annualRate'),
                years: document.getElementById('years'),
                inflationRate: document.getElementById('inflationRate'),
                annualRateSlider: document.getElementById('annualRateSlider'),
                yearsSlider: document.getElementById('yearsSlider'),
                inflationRateSlider: document.getElementById('inflationRateSlider'),
            },
            outputs: {
                futureValue: document.getElementById('futureValue'),
                realFutureValue: document.getElementById('realFutureValue'),
                detailsTableBody: document.getElementById('detailsTableBody'),
                requiredMonthly: document.getElementById('requiredMonthly'),
                goalSummary: document.getElementById('goal-summary'),
            },
            charts: { growth: document.getElementById('growthChart').getContext('2d')},
            inflationInputContainer: document.getElementById('inflation-input-container'),
        };

        let growthChart;
        let currentMode = 'projection';
        const formatter = new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 });

        // --- Core Logic ---
        function calculateAndRender() {
            if (currentMode === 'projection') {
                calculateProjection();
            } else {
                calculateGoal();
            }
        }
        
        function getCommonInputs() {
            return {
                r: (parseFloat(DOMElements.inputs.annualRate.value) || 0) / 100,
                t: parseInt(DOMElements.inputs.years.value) || 0,
                inflation: (parseFloat(DOMElements.inputs.inflationRate.value) || 0) / 100,
            };
        }
        
        // --- Projection Mode Logic ---
        function calculateProjection() {
            const P = parseFloat(DOMElements.inputs.initialPrincipal.value) || 0;
            const PMT = parseFloat(DOMElements.inputs.monthlyContribution.value) || 0;
            const { r, t, inflation } = getCommonInputs();
            const n = 12;
            const monthlyRate = r / n;

            let yearlyDetails = [];
            let lastYearEndValue = P;
            const labels = ['第0年'];
            const futureValueData = [P];
            const realFutureValueData = [P];

            for (let year = 1; year <= t; year++) {
                let yearStartValue = lastYearEndValue;
                let yearEndValue = yearStartValue;
                let yearContribution = 0;
                for (let month = 1; month <= n; month++) {
                    yearEndValue = yearEndValue * (1 + monthlyRate) + PMT;
                    yearContribution += PMT;
                }
                const yearInterest = yearEndValue - yearStartValue - yearContribution;
                yearlyDetails.push({ year, contribution: yearContribution, interest: yearInterest, endValue: yearEndValue });
                lastYearEndValue = yearEndValue;
                
                labels.push(`第${year}年`);
                futureValueData.push(yearEndValue);
                realFutureValueData.push(yearEndValue / Math.pow(1 + inflation, year));
            }
            const finalFutureValue = t > 0 ? lastYearEndValue : P;
            const finalRealValue = t > 0 ? finalFutureValue / Math.pow(1 + inflation, t) : P;

            updateProjectionUI(finalFutureValue, finalRealValue, yearlyDetails);
            createOrUpdateChart(labels, futureValueData, realFutureValueData);
        }
        
        // --- Goal Mode Logic ---
        function calculateGoal() {
            const FV = parseFloat(DOMElements.inputs.financialGoal.value) || 0;
            const P = parseFloat(DOMElements.inputs.initialPrincipalGoal.value) || 0;
            const { r, t } = getCommonInputs();
            const n = 12;
            const monthlyRate = r / n;
            const totalPeriods = t * n;
            
            let requiredPMT = 0;
            if (totalPeriods > 0) {
                if (monthlyRate > 0) {
                     requiredPMT = (FV - P * Math.pow(1 + monthlyRate, totalPeriods)) / ((Math.pow(1 + monthlyRate, totalPeriods) - 1) / monthlyRate);
                } else {
                    requiredPMT = (FV - P) / totalPeriods;
                }
            }
            updateGoalUI(requiredPMT, FV, t);
        }

        // --- UI Update Functions ---
        function updateProjectionUI(fv, r_fv, details) {
            DOMElements.outputs.futureValue.textContent = formatter.format(fv);
            DOMElements.outputs.realFutureValue.textContent = formatter.format(r_fv);
            animateValue(DOMElements.outputs.futureValue);
            animateValue(DOMElements.outputs.realFutureValue);
            
            let tableHTML = '';
            details.forEach(item => {
                tableHTML += `<tr class="bg-white border-b hover:bg-slate-50"><td class="px-4 py-2 font-medium">${item.year}</td><td class="px-4 py-2 text-right">${formatter.format(item.contribution)}</td><td class="px-4 py-2 text-right">${formatter.format(item.interest)}</td><td class="px-4 py-2 text-right font-semibold text-slate-800">${formatter.format(item.endValue)}</td></tr>`;
            });
            DOMElements.outputs.detailsTableBody.innerHTML = tableHTML;
        }
        
        function updateGoalUI(pmt, fv, t) {
            DOMElements.outputs.requiredMonthly.textContent = formatter.format(Math.max(0, pmt));
            animateValue(DOMElements.outputs.requiredMonthly);
            DOMElements.outputs.goalSummary.textContent = `在 ${t} 年後，達成 ${formatter.format(fv)} 的目標。`;
        }

        function createOrUpdateChart(labels, futureValueData, realFutureValueData) {
            if (growthChart) growthChart.destroy();
            growthChart = new Chart(DOMElements.charts.growth, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: '實質購買力', data: realFutureValueData, backgroundColor: 'rgba(13, 148, 136, 0.2)', borderColor: 'rgb(13, 148, 136)', fill: true, tension: 0.2 },
                        { label: '累積總額 (名目)', data: futureValueData, backgroundColor: 'rgba(79, 70, 229, 0.2)', borderColor: 'rgb(79, 70, 229)', fill: true, tension: 0.2 },
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: value => (value >= 100000000) ? `${value / 100000000}億` : `${value / 10000}萬` } } }, plugins: { legend: { position: 'bottom' } } }
            });
        }
        
        function animateValue(element) {
            element.classList.add('value-update');
            element.addEventListener('animationend', () => element.classList.remove('value-update'), { once: true });
        }

        // --- Event Handlers & Initialization ---
        function handleTabClick(mode) {
            currentMode = mode;
            DOMElements.tabs.projection.classList.toggle('active', mode === 'projection');
            DOMElements.tabs.goal.classList.toggle('active', mode === 'goal');
            DOMElements.inputSections.projection.classList.toggle('hidden', mode !== 'projection');
            DOMElements.inputSections.goal.classList.toggle('hidden', mode !== 'goal');
            DOMElements.resultSections.projection.classList.toggle('hidden', mode !== 'projection');
            DOMElements.resultSections.goal.classList.toggle('hidden', mode !== 'goal');
            DOMElements.inflationInputContainer.classList.toggle('hidden', mode === 'goal');
            calculateAndRender();
        }
        
        function handleInputChange(e) {
            const { id, value } = e.target;
            const sliderId = id.includes('Slider') ? id : id + 'Slider';
            const inputId = id.includes('Slider') ? id.replace('Slider', '') : id;
            if (document.getElementById(sliderId)) document.getElementById(sliderId).value = value;
            if (document.getElementById(inputId)) document.getElementById(inputId).value = value;

            if(id === 'initialPrincipal') DOMElements.inputs.initialPrincipalGoal.value = value;
            if(id === 'initialPrincipalGoal') DOMElements.inputs.initialPrincipal.value = value;
            calculateAndRender();
        }
        
        function initialize() {
            Object.values(DOMElements.inputs).forEach(input => input.addEventListener('input', handleInputChange));
            DOMElements.tabs.projection.addEventListener('click', () => handleTabClick('projection'));
            DOMElements.tabs.goal.addEventListener('click', () => handleTabClick('goal'));
            handleTabClick('projection');
        }

        window.addEventListener('load', initialize);
    </script>
</body>
</html>


